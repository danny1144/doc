<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>log process demo | Zhong XiaoPing</title>
    <meta name="description" content="">
    <link rel="icon" href="/img/logo.jpeg">
    
    <link rel="preload" href="/assets/css/0.styles.c64eb42f.css" as="style"><link rel="preload" href="/assets/js/app.d08fdf74.js" as="script"><link rel="preload" href="/assets/js/6.617a445e.js" as="script"><link rel="preload" href="/assets/js/16.56e17172.js" as="script"><link rel="prefetch" href="/assets/js/10.e318fc11.js"><link rel="prefetch" href="/assets/js/11.8c37c994.js"><link rel="prefetch" href="/assets/js/12.e9cf4945.js"><link rel="prefetch" href="/assets/js/13.9bdef388.js"><link rel="prefetch" href="/assets/js/14.00f01860.js"><link rel="prefetch" href="/assets/js/15.047f3050.js"><link rel="prefetch" href="/assets/js/17.d720ecc7.js"><link rel="prefetch" href="/assets/js/18.bbe7c25d.js"><link rel="prefetch" href="/assets/js/19.50b11d97.js"><link rel="prefetch" href="/assets/js/2.af16cb48.js"><link rel="prefetch" href="/assets/js/3.ae1edefa.js"><link rel="prefetch" href="/assets/js/4.4b2e749c.js"><link rel="prefetch" href="/assets/js/5.23ca8b95.js"><link rel="prefetch" href="/assets/js/7.2762017d.js"><link rel="prefetch" href="/assets/js/8.0371e81a.js"><link rel="prefetch" href="/assets/js/9.febe774a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c64eb42f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpeg" alt="Zhong XiaoPing" class="logo"> <span class="site-name can-hide">Zhong XiaoPing</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/timeLine/" class="nav-link">首页</a></div><div class="nav-item"><a href="/technology/" class="nav-link router-link-active">技术</a></div><div class="nav-item"><a href="/life/" class="nav-link">生活</a></div><div class="nav-item"><a href="/ponder/" class="nav-link">思考</a></div><div class="nav-item"><a href="/tags/" class="nav-link">标签库</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/massage/" class="nav-link">留言板</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">链接</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.jianshu.com/u/a053df515092" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/danny1144" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/zxp110" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav> <div style="margin-left:20px;margin-right:20px;">
   音乐
  <div role="switch" class="el-switch"><input type="checkbox" name="" true-value="true" class="el-switch__input"><!----><span class="el-switch__core" style="width:40px;"></span><!----></div> <audio loop="loop"><source src="/assets/media/buyizuishiliangbuyi.82f2a68a.mp3" type="audio/mpeg"></audio></div></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/timeLine/" class="nav-link">首页</a></div><div class="nav-item"><a href="/technology/" class="nav-link router-link-active">技术</a></div><div class="nav-item"><a href="/life/" class="nav-link">生活</a></div><div class="nav-item"><a href="/ponder/" class="nav-link">思考</a></div><div class="nav-item"><a href="/tags/" class="nav-link">标签库</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/massage/" class="nav-link">留言板</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">链接</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.jianshu.com/u/a053df515092" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/danny1144" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/zxp110" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <!----> </div> <div class="page"> <div class="content"><h2 id="简介"><a href="#简介" aria-hidden="true" class="header-anchor">#</a> 简介</h2> <blockquote><p>Fluentd负责收集日志,
Fluentd 主要由Input输出、Buffer缓冲、Output输出三大部分组成。这三大部分都是以插件的形式存在。当然还有其他辅助插件如Filter、Formatter等用于数据处理或格式化。输出至elasticsearch依赖插件</p></blockquote> <blockquote><p>fluent-plugin-elasticsearch,(/opt/td-agent/embedded/bin/fluent-gem install fluent-plugin-elasticsearch)</p></blockquote> <blockquote><p>Fluentd配置</p></blockquote> <ul><li>source: 数据源配置，可接受log-tail、http、tcp、udp等方式数据，</li> <li>filter: 数据过滤配置，对匹配的tag进行过滤</li> <li>match: 数据输出配置，对匹配的tag进行输出设置</li></ul> <blockquote><p>Elasticsearch存储日志并提供搜索<br>
Elasticsearch是个开源分布式搜索引擎，提供搜集、分析、存储数据三大功能。它的特点有：分布式，零配置，自动发现，索引自动分片，索引副本机制，restful风格接口，多数据源，自动搜索负载等。</p></blockquote> <blockquote><p>Kibana负责日志查询和展示
Kibana可以为 Logstash 、Beats和 ElasticSearch 提供的日志分析友好的 Web 界面，可以帮助汇总、分析和搜索重要数据日志。
配置index:
　　一般情况下，当启动Kibana的时候会自动搜索可用来展示的索引，如果你需要的没有被搜到，或者如上面新增的数据的索引没有检测到，那么key手动添加索引。配置index的位置为：</p></blockquote> <blockquote><p>注意：</p></blockquote> <ul><li>1、每次修改fluentd.conf配置文件后。如果涉及索引的新增或者字段新增。需要刷新kibana索引。</li> <li>2、logstash.outputs.elasticsearch] retrying failed action with response code: 403 ({&quot;type&quot;=&gt;&quot;cluster_block_exception&quot;, &quot;reason&quot;=&gt;&quot;blocked by: [FORBIDDEN/12/index read-only / allow delete (api)]
这是由于ES新节点的数据目录data存储空间不足，导致从master主节点接收同步数据的时候失败，此时ES集群为了保护数据，会自动把索引分片index置为只读read-only</li></ul> <blockquote><p>解决步骤：</p></blockquote> <ul><li>1.提供足够的存储空间供数据写入，如需在配置文件中更改ES数据存储目录，注意重启ES</li> <li>2.放开索引只读设置，在Kibana的开发工具Dev Tools中执行（或在服务器上通过curl工具发起PUT请求，下文同）</li></ul> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token constant">PUT</span> <span class="token operator">/</span>_all<span class="token operator">/</span>_settings

<span class="token punctuation">{</span> 

<span class="token string">&quot;index.blocks.read_only_allow_delete&quot;</span><span class="token punctuation">:</span> <span class="token keyword">null</span> 

<span class="token punctuation">}</span>
 
<span class="token operator">&gt;</span> logback的配置介绍

Logger、appender及layout

　　Logger作为日志的记录器，把它关联到应用的对应的context上后，主要用于存放日志对象，也可以定义日志类型、级别。

　　Appender主要用于指定日志输出的目的地，目的地可以是控制台、文件、远程套接字服务器、 MySQL、PostreSQL、 Oracle和其他数据库、 <span class="token constant">JMS</span>和远程<span class="token constant">UNIX</span> Syslog守护进程等。

　　Layout 负责把事件转换成字符串，格式化的日志信息的输出。

<span class="token operator">&gt;</span> logger context

　　各个logger 都被关联到一个 LoggerContext，LoggerContext负责制造logger，也负责以树结构排列各logger。其他所有logger也通过org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>LoggerFactory 类的静态方法getLogger取得。 getLogger方法以 logger名称为参数。用同一名字调用LoggerFactory<span class="token punctuation">.</span>getLogger 方法所得到的永远都是同一个logger对象的引用。

<span class="token operator">&gt;</span> 有效级别及级别的继承

　　Logger 可以被分配级别。级别包括：<span class="token constant">TRACE</span>、<span class="token constant">DEBUG</span>、<span class="token constant">INFO</span>、<span class="token constant">WARN</span> 和 <span class="token constant">ERROR</span>，定义于ch<span class="token punctuation">.</span>qos<span class="token punctuation">.</span>logback<span class="token punctuation">.</span>classic<span class="token punctuation">.</span>Level类。如果 logger没有被分配级别，那么它将从有被分配级别的最近的祖先那里继承级别。root logger 默认级别是 <span class="token constant">DEBUG</span>。

<span class="token operator">&gt;</span> 打印方法与基本的选择规则

打印方法决定记录请求的级别。例如，如果 <span class="token constant">L</span> 是一个 logger 实例，那么，语句 <span class="token constant">L</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;..&quot;</span><span class="token punctuation">)</span>是一条级别为 <span class="token constant">INFO</span>的记录语句。记录请求的级别在高于或等于其 logger 的有效级别时被称为被启用，否则，称为被禁用。记录请求级别为 p，其 logger的有效级别为 q，只有则当 p<span class="token operator">&gt;=</span>q时，该请求才会被执行。

该规则是 logback 的核心。级别排序为： <span class="token constant">TRACE</span> <span class="token operator">&lt;</span> <span class="token constant">DEBUG</span> <span class="token operator">&lt;</span> <span class="token constant">INFO</span> <span class="token operator">&lt;</span> <span class="token constant">WARN</span> <span class="token operator">&lt;</span> <span class="token constant">ERROR</span>

 logback配置文件
<span class="token template-string"><span class="token string">``</span></span>` xml
<span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">&quot;1.0&quot;</span> encoding<span class="token operator">=</span><span class="token string">&quot;ISO-8859-1&quot;</span><span class="token operator">?</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>configuration  scan<span class="token operator">=</span><span class="token string">&quot;true&quot;</span> scanPeriod<span class="token operator">=</span><span class="token string">&quot;5 minutes&quot;</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>conversionRule conversionWord<span class="token operator">=</span><span class="token string">&quot;serverIp&quot;</span> converterClass<span class="token operator">=</span><span class="token string">&quot;com.siemens.ofmasset.common.log.ServerIp&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>conversionRule conversionWord<span class="token operator">=</span><span class="token string">&quot;serverName&quot;</span> converterClass<span class="token operator">=</span><span class="token string">&quot;com.siemens.ofmasset.common.log.ServerName&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>conversionRule conversionWord<span class="token operator">=</span><span class="token string">&quot;operationType&quot;</span> converterClass<span class="token operator">=</span><span class="token string">&quot;com.siemens.ofmasset.common.log.OperationType&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>conversionRule conversionWord<span class="token operator">=</span><span class="token string">&quot;operationContent&quot;</span> converterClass<span class="token operator">=</span><span class="token string">&quot;com.siemens.ofmasset.common.log.OperationContiant&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>contextName<span class="token operator">&gt;</span>dpp<span class="token operator">&lt;</span><span class="token operator">/</span>contextName<span class="token operator">&gt;</span>



    <span class="token operator">&lt;</span>appender name<span class="token operator">=</span><span class="token string">&quot;STDOUT&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span><span class="token operator">&gt;</span>

        <span class="token operator">&lt;</span>encoder<span class="token operator">&gt;</span>

            <span class="token operator">&lt;</span>Pattern<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token operator">%</span>d<span class="token punctuation">{</span>yyyy<span class="token operator">-</span><span class="token constant">MM</span><span class="token operator">-</span>dd <span class="token constant">HH</span><span class="token punctuation">:</span>mm<span class="token punctuation">:</span>ss <span class="token constant">Z</span><span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">%</span><span class="token operator">-</span><span class="token number">5</span>level<span class="token punctuation">]</span> <span class="token punctuation">[</span>dpp<span class="token punctuation">]</span> <span class="token punctuation">[</span>ofm<span class="token operator">-</span>asset<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">%</span>serverName<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">%</span>serverIp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">%</span>logger<span class="token punctuation">{</span><span class="token number">36</span><span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">%</span>operationType<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">%</span>operationContent<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>thread<span class="token operator">-</span><span class="token operator">%</span>thread<span class="token punctuation">]</span> <span class="token operator">%</span>n<span class="token operator">&lt;</span><span class="token operator">/</span>Pattern<span class="token operator">&gt;</span>

        <span class="token operator">&lt;</span><span class="token operator">/</span>encoder<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span><span class="token operator">/</span>appender<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>appender name<span class="token operator">=</span><span class="token string">&quot;FLUENT_TEXT&quot;</span>

<span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;ch.qos.logback.more.appenders.FluentLogbackAppender&quot;</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> Tag <span class="token keyword">for</span> Fluentd<span class="token punctuation">.</span> Farther information<span class="token punctuation">:</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>fluentd<span class="token punctuation">.</span>org<span class="token operator">/</span>articles<span class="token operator">/</span>config<span class="token operator">-</span>file <span class="token operator">--</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>tag<span class="token operator">&gt;</span>ofm<span class="token operator">-</span>asset<span class="token operator">&lt;</span><span class="token operator">/</span>tag<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> <span class="token punctuation">[</span>Optional<span class="token punctuation">]</span> Label <span class="token keyword">for</span> Fluentd<span class="token punctuation">.</span> Farther information<span class="token punctuation">:</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>fluentd<span class="token punctuation">.</span>org<span class="token operator">/</span>articles<span class="token operator">/</span>config<span class="token operator">-</span>file <span class="token operator">--</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> Host name<span class="token operator">/</span>address and port number which Flentd placed <span class="token operator">--</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>remoteHost<span class="token operator">&gt;</span><span class="token number">10.192</span><span class="token number">.30</span><span class="token number">.192</span><span class="token operator">&lt;</span><span class="token operator">/</span>remoteHost<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>port<span class="token operator">&gt;</span><span class="token number">24224</span><span class="token operator">&lt;</span><span class="token operator">/</span>port<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> Max queue size <span class="token keyword">of</span> logs which is waiting to be <span class="token function">sent</span> <span class="token punctuation">(</span>When it reach

to the max size<span class="token punctuation">,</span> the log will be disappeared<span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token operator">--</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>maxQueueSize<span class="token operator">&gt;</span><span class="token number">999999</span><span class="token operator">&lt;</span><span class="token operator">/</span>maxQueueSize<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>layout <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;com.siemens.ofmasset.common.log.AssetPatternLayout&quot;</span><span class="token operator">&gt;</span>

          <span class="token operator">&lt;</span>Pattern<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token operator">%</span>d<span class="token punctuation">{</span>yyyy<span class="token operator">-</span><span class="token constant">MM</span><span class="token operator">-</span>dd <span class="token constant">HH</span><span class="token punctuation">:</span>mm<span class="token punctuation">:</span>ss <span class="token constant">Z</span><span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">%</span><span class="token operator">-</span><span class="token number">5</span>level<span class="token punctuation">]</span> <span class="token punctuation">[</span>dpp<span class="token punctuation">]</span> <span class="token punctuation">[</span>ofm<span class="token operator">-</span>asset<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">%</span>serverName<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">%</span>serverIp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">%</span>logger<span class="token punctuation">{</span><span class="token number">36</span><span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">%</span>operationType<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">%</span>operationContent<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>thread<span class="token operator">-</span><span class="token operator">%</span>thread<span class="token punctuation">]</span> <span class="token operator">%</span>n<span class="token operator">&lt;</span><span class="token operator">/</span>Pattern<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>layout<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>appender<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>logger name<span class="token operator">=</span><span class="token string">&quot;druid.sql&quot;</span> level<span class="token operator">=</span><span class="token string">&quot;INFO&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>logger name<span class="token operator">=</span><span class="token string">&quot;com.alibaba.druid&quot;</span> level<span class="token operator">=</span><span class="token string">&quot;INFO&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>logger name<span class="token operator">=</span><span class="token string">&quot;access&quot;</span> level<span class="token operator">=</span><span class="token string">&quot;INFO&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>logger name<span class="token operator">=</span><span class="token string">&quot;service&quot;</span> level<span class="token operator">=</span><span class="token string">&quot;INFO&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>logger name<span class="token operator">=</span><span class="token string">&quot;logback&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>



    <span class="token operator">&lt;</span>logger name<span class="token operator">=</span><span class="token string">&quot;com.siemens&quot;</span> level<span class="token operator">=</span><span class="token string">&quot;info&quot;</span> additivity<span class="token operator">=</span><span class="token string">&quot;true&quot;</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>appender<span class="token operator">-</span>ref ref<span class="token operator">=</span><span class="token string">&quot;FLUENT_TEXT&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>logger<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>root level<span class="token operator">=</span><span class="token string">&quot;info&quot;</span><span class="token operator">&gt;</span>

        <span class="token operator">&lt;</span>appender<span class="token operator">-</span>ref ref<span class="token operator">=</span><span class="token string">&quot;STDOUT&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span><span class="token operator">/</span>root<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>configuration<span class="token operator">&gt;</span>
</code></pre></div><p>fluentd配置文件</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token operator">&lt;</span>source<span class="token operator">&gt;</span>

  @type forward

  port <span class="token number">24224</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>source<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>source<span class="token operator">&gt;</span>

  @type http

  port <span class="token number">8081</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>source<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>system<span class="token operator">&gt;</span>

  #  处理<span class="token number">10</span>亿级别的日志输入时，<span class="token constant">CPU</span>会出现瓶颈，这时考虑增加工作进程数量：

  workers <span class="token number">8</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>system<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>filter ofm<span class="token operator">-</span>asset<span class="token operator">&gt;</span>

    @type record_transformer

    enable_ruby

# 从<span class="token punctuation">[</span><span class="token operator">%</span>d<span class="token punctuation">{</span>yyyy<span class="token operator">-</span><span class="token constant">MM</span><span class="token operator">-</span>dd <span class="token constant">HH</span><span class="token punctuation">:</span>mm<span class="token punctuation">:</span>ss <span class="token constant">Z</span><span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">%</span><span class="token operator">-</span><span class="token number">5</span>level<span class="token punctuation">]</span> <span class="token punctuation">[</span>dpp<span class="token punctuation">]</span> <span class="token punctuation">[</span>ofm<span class="token operator">-</span>asset<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">%</span>serverName<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">%</span>serverIp<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">%</span>logger<span class="token punctuation">{</span><span class="token number">36</span><span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">%</span>operationType<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">%</span>operationContent<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>thread<span class="token operator">-</span><span class="token operator">%</span>thread<span class="token punctuation">]</span> <span class="token operator">%</span>n

    # 形式的Logback Pattern中抽取字段<span class="token punctuation">,</span>用于过滤查询

  <span class="token operator">&lt;</span>record<span class="token operator">&gt;</span>

      level  $<span class="token punctuation">{</span>record<span class="token punctuation">[</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">}</span>

    <span class="token operator">&lt;</span><span class="token operator">/</span>record<span class="token operator">&gt;</span>

  <span class="token operator">&lt;</span><span class="token operator">/</span>filter<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>match <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">**</span><span class="token operator">&gt;</span>

  type copy

  # 输出到elasticsearch

  <span class="token operator">&lt;</span>store<span class="token operator">&gt;</span>

    @type elasticsearch

    host <span class="token number">10.192</span><span class="token number">.30</span><span class="token number">.192</span>

    port <span class="token number">9200</span>

    logstash_format <span class="token boolean">true</span>

    logstash_prefix fluentd<span class="token operator">-</span>$<span class="token punctuation">{</span>tag<span class="token punctuation">}</span>

    logstash_dateformat <span class="token operator">%</span><span class="token constant">Y</span><span class="token operator">%</span>m<span class="token operator">%</span>d

    include_tag_key <span class="token boolean">true</span>

    type_name access_log

    tag_key log_name

    level

    flush_interval <span class="token number">10</span>s

  flush_thread_count  <span class="token number">10</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>store<span class="token operator">&gt;</span>

# 用于控制台输出

<span class="token operator">&lt;</span>store<span class="token operator">&gt;</span>

    @type stdout

  <span class="token operator">&lt;</span><span class="token operator">/</span>store<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>match<span class="token operator">&gt;</span>
</code></pre></div><p>java测试代码</p> <p>maven依赖：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.sndyuk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>logback-more-appenders<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.5.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.fluentd<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fluent-logger<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${fluentd.logger.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>   
@Slf4j

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestLogController</span> <span class="token punctuation">{</span>

  @<span class="token function">GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;info&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">public</span> String <span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;info msg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token string">&quot;info&quot;</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

  @<span class="token function">GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;warn&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">public</span> String <span class="token function">warn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;warn msg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token string">&quot;warn&quot;</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

  @<span class="token function">GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">public</span> String <span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;info msg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">-</span>

        <span class="token keyword">return</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>测试请求打印日志如下</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token operator">-</span> curl http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">8009</span><span class="token operator">/</span>asset<span class="token comment">//log/info</span>

<span class="token operator">-</span> curl http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">8009</span><span class="token operator">/</span>asset<span class="token comment">//log/warn</span>

<span class="token operator">-</span> curl http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">8009</span><span class="token operator">/</span>asset<span class="token comment">//log/error</span>
</code></pre></div><p>日志记录：</p> <ul><li><p><a href="http://10.192.30.192:5601/app/kibana#/discover/7c0c88a0-9325-11e9-91cb-af2618cf1d31?_g=(refreshInterval%3A(display%3AOff%2Cpause%3A!f%2Cvalue%3A0)%2Ctime%3A(from%3Anow%2Fd%2Cmode%3Aquick%2Cto%3Anow%2Fd))" target="_blank" rel="noopener noreferrer">WARN:<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="http://10.192.30.192:5601/app/kibana#/discover/9bb1bae0-9325-11e9-91cb-af2618cf1d31?_g=(refreshInterval%3A(display%3AOff%2Cpause%3A!f%2Cvalue%3A0)%2Ctime%3A(from%3Anow%2Fd%2Cmode%3Aquick%2Cto%3Anow%2Fd))" target="_blank" rel="noopener noreferrer">ERROR:<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="http://10.192.30.192:5601/app/kibana#/discover/150a2b80-92fd-11e9-91cb-af2618cf1d31?_g=(refreshInterval%3A(display%3AOff%2Cpause%3A!f%2Cvalue%3A0)%2Ctime%3A(from%3Anow%2Fd%2Cmode%3Aquick%2Cto%3Anow%2Fd))" target="_blank" rel="noopener noreferrer">INFO:<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ul> <h2 id="参考资料"><a href="#参考资料" aria-hidden="true" class="header-anchor">#</a> 参考资料</h2> <ul><li><p>1、<a href="https://blog.gmem.cc/efk-as-a-log-analysis-system" target="_blank" rel="noopener noreferrer">绿色联盟<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p>2、<a href="https://docs.fluentd.org/deployment/logging#per-plugin-log" target="_blank" rel="noopener noreferrer">官方网站<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ul></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.d08fdf74.js" defer></script><script src="/assets/js/6.617a445e.js" defer></script><script src="/assets/js/16.56e17172.js" defer></script>
  </body>
</html>
