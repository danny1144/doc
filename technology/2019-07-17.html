<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>日志链路追踪 | 其实，我是一名程序员</title>
    <meta name="description" content="">
    <link rel="icon" href="/img/logo.jpeg">
    
    <link rel="preload" href="/assets/css/0.styles.ec5334b5.css" as="style"><link rel="preload" href="/assets/js/app.fbf1b08b.js" as="script"><link rel="preload" href="/assets/js/8.6b440de9.js" as="script"><link rel="preload" href="/assets/js/28.0251e2b8.js" as="script"><link rel="prefetch" href="/assets/js/10.89f811b8.js"><link rel="prefetch" href="/assets/js/11.0e190245.js"><link rel="prefetch" href="/assets/js/12.13a8ea5f.js"><link rel="prefetch" href="/assets/js/13.8f8f40c0.js"><link rel="prefetch" href="/assets/js/14.e75033fb.js"><link rel="prefetch" href="/assets/js/15.205f722e.js"><link rel="prefetch" href="/assets/js/16.66673bf2.js"><link rel="prefetch" href="/assets/js/17.5435c650.js"><link rel="prefetch" href="/assets/js/18.71b2c1fb.js"><link rel="prefetch" href="/assets/js/19.5f8b3901.js"><link rel="prefetch" href="/assets/js/2.63f3f567.js"><link rel="prefetch" href="/assets/js/20.bb4d6477.js"><link rel="prefetch" href="/assets/js/21.d59072e9.js"><link rel="prefetch" href="/assets/js/22.4d0029c9.js"><link rel="prefetch" href="/assets/js/23.03a51856.js"><link rel="prefetch" href="/assets/js/24.351ac71c.js"><link rel="prefetch" href="/assets/js/25.fcd7cac4.js"><link rel="prefetch" href="/assets/js/26.b2613bc7.js"><link rel="prefetch" href="/assets/js/27.164921bf.js"><link rel="prefetch" href="/assets/js/29.da86b351.js"><link rel="prefetch" href="/assets/js/3.67263ba4.js"><link rel="prefetch" href="/assets/js/30.deb53385.js"><link rel="prefetch" href="/assets/js/31.60246431.js"><link rel="prefetch" href="/assets/js/32.88b0ca03.js"><link rel="prefetch" href="/assets/js/33.49d346dd.js"><link rel="prefetch" href="/assets/js/34.04b2e52e.js"><link rel="prefetch" href="/assets/js/35.a9c5bc55.js"><link rel="prefetch" href="/assets/js/36.7c2c67e1.js"><link rel="prefetch" href="/assets/js/37.ebb59915.js"><link rel="prefetch" href="/assets/js/38.8597b6ef.js"><link rel="prefetch" href="/assets/js/39.50923ae2.js"><link rel="prefetch" href="/assets/js/4.287bab32.js"><link rel="prefetch" href="/assets/js/40.483fa3c9.js"><link rel="prefetch" href="/assets/js/5.ce17c05f.js"><link rel="prefetch" href="/assets/js/6.6b7bba6e.js"><link rel="prefetch" href="/assets/js/7.02ebcd87.js"><link rel="prefetch" href="/assets/js/9.da60ceff.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ec5334b5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpeg" alt="其实，我是一名程序员" class="logo"> <span class="site-name can-hide">其实，我是一名程序员</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/timeLine/" class="nav-link">首页</a></div><div class="nav-item"><a href="/technology/" class="nav-link router-link-active">技术</a></div><div class="nav-item"><a href="/life/" class="nav-link">生活</a></div><div class="nav-item"><a href="/ponder/" class="nav-link">思考</a></div><div class="nav-item"><a href="/tags/" class="nav-link">标签库</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/massage/" class="nav-link">留言板</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">链接</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.jianshu.com/u/a053df515092" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/danny1144" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/zxp110" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav> <div style="margin-left:20px;margin-right:20px;">
   音乐
  <div role="switch" class="el-switch"><input type="checkbox" name="" true-value="true" class="el-switch__input"><!----><span class="el-switch__core" style="width:40px;"></span><!----></div> <audio loop="loop"><source src="/assets/media/buyizuishiliangbuyi.82f2a68a.mp3" type="audio/mpeg"></audio></div></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/timeLine/" class="nav-link">首页</a></div><div class="nav-item"><a href="/technology/" class="nav-link router-link-active">技术</a></div><div class="nav-item"><a href="/life/" class="nav-link">生活</a></div><div class="nav-item"><a href="/ponder/" class="nav-link">思考</a></div><div class="nav-item"><a href="/tags/" class="nav-link">标签库</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/massage/" class="nav-link">留言板</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">链接</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.jianshu.com/u/a053df515092" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/danny1144" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/zxp110" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>日志链路追踪</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/technology/2019-07-17.html#日志规范" class="sidebar-link">日志规范</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/2019-07-17.html#系统日志字段以及每个字段的格式：" class="sidebar-link">系统日志字段以及每个字段的格式：</a></li><li class="sidebar-sub-header"><a href="/technology/2019-07-17.html#日志格式" class="sidebar-link">日志格式</a></li><li class="sidebar-sub-header"><a href="/technology/2019-07-17.html#使用样例" class="sidebar-link">使用样例</a></li></ul></li><li><a href="/technology/2019-07-17.html#方法一" class="sidebar-link">方法一</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/2019-07-17.html#实现自定义converter" class="sidebar-link">实现自定义Converter</a></li><li class="sidebar-sub-header"><a href="/technology/2019-07-17.html#修改配置文件" class="sidebar-link">修改配置文件</a></li></ul></li><li><a href="/technology/2019-07-17.html#方法二" class="sidebar-link">方法二</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/2019-07-17.html#使用注解方式自定义注解" class="sidebar-link">使用注解方式自定义注解</a></li><li class="sidebar-sub-header"><a href="/technology/2019-07-17.html#方法添加注解" class="sidebar-link">方法添加注解</a></li><li class="sidebar-sub-header"><a href="/technology/2019-07-17.html#注解值放置到日志容器mdc" class="sidebar-link">注解值放置到日志容器MDC</a></li><li class="sidebar-sub-header"><a href="/technology/2019-07-17.html#修改配置文件logback-xml" class="sidebar-link">修改配置文件logback.xml</a></li><li class="sidebar-sub-header"><a href="/technology/2019-07-17.html#输出样例" class="sidebar-link">输出样例</a></li><li class="sidebar-sub-header"><a href="/technology/2019-07-17.html#自定义规则" class="sidebar-link">自定义规则</a></li><li class="sidebar-sub-header"><a href="/technology/2019-07-17.html#系统已存在可使用规则" class="sidebar-link">系统已存在可使用规则</a></li><li class="sidebar-sub-header"><a href="/technology/2019-07-17.html#涉及的方法" class="sidebar-link">涉及的方法</a></li><li class="sidebar-sub-header"><a href="/technology/2019-07-17.html#微服务日志跟踪" class="sidebar-link">微服务日志跟踪</a></li><li class="sidebar-sub-header"><a href="/technology/2019-07-17.html#依赖" class="sidebar-link">依赖</a></li><li class="sidebar-sub-header"><a href="/technology/2019-07-17.html#一个简单的web应用链路" class="sidebar-link">一个简单的WEB应用链路</a></li></ul></li><li><a href="/technology/2019-07-17.html#查看日志" class="sidebar-link">查看日志</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technology/2019-07-17.html#user模块" class="sidebar-link">user模块</a></li><li class="sidebar-sub-header"><a href="/technology/2019-07-17.html#sso模块" class="sidebar-link">sso模块</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h2 id="日志规范"><a href="#日志规范" class="header-anchor">#</a> 日志规范</h2> <p>系统操作日志：一般用于记录用户在系统中所做的各种操作，根据业务的需求不同，记录的日志内容也不一样。记录日志包含系统已经提供规则和自定义规则。原本项目组在每个微服务中定义了日志规则，现在统一在ofm-common中添加自定义规则。
note:
新增动态添加traceId前缀。由前端在请求头中增加tracePreFix动态显示日志链路路径。</p> <h3 id="系统日志字段以及每个字段的格式："><a href="#系统日志字段以及每个字段的格式：" class="header-anchor">#</a> 系统日志字段以及每个字段的格式：</h3> <table><thead><tr><th><strong>项目</strong></th> <th><strong>是否必填</strong></th> <th><strong>格式</strong></th> <th><strong>说明</strong></th></tr></thead> <tbody><tr><td>时间</td> <td>Y</td> <td>[2019-07-04 12:46:35,648 ]</td> <td>例子：LOG4j 指令[%d]</td></tr> <tr><td>日志级别</td> <td>Y</td> <td>[INFO ]</td> <td>DEBUG,   WARN,INFO, ERROR</td></tr> <tr><td>线程名称</td> <td>Y</td> <td>[http-nio-8091-exec-2]</td> <td>[%thread]</td></tr> <tr><td>日志</td> <td>Y</td> <td>[%logger{36}]</td> <td>输出产生log事件的原点的日志名   [%logger{36}]</td></tr> <tr><td>traceId</td> <td>Y</td> <td>[%X{X-B3-TraceId:-}]</td> <td>分布式日志追踪   [%X{X-B3-TraceId:-}]</td></tr> <tr><td>分布式追踪前缀</td> <td>N</td> <td>[%X{tracePreFix} ]</td> <td>%X{tracePreFix}用于方便日志追踪关键字搜索   非必填</td></tr> <tr><td>日志打印的行</td> <td>Y</td> <td>[line-79]</td> <td>[line-%line]</td></tr> <tr><td>系统名称</td> <td>Y</td> <td>[ofm]</td> <td>系统名称，字符串ofm</td></tr> <tr><td>业务模块名称</td> <td>Y</td> <td>[user]</td> <td>模块名称，字符串，  各个logback自定义</td></tr> <tr><td>用户请求ip</td> <td>Y</td> <td>[172.19.210.145]</td> <td>客户端ip</td></tr> <tr><td>服务器名称</td> <td>Y</td> <td>[md1tz9pc]</td> <td>[%serverName]</td></tr> <tr><td>服务器IP</td> <td>Y</td> <td>[10.0.75.1]</td> <td>[%serverIp]</td></tr> <tr><td>用户名</td> <td>Y</td> <td>[admin123456]</td> <td>用户的  ID   [userId-%X{userId}]</td></tr> <tr><td>操作类型</td> <td>Y</td> <td>[logout]</td> <td>操作类型，打开，保存，关闭,登录，登出，超时 之一[ADD，EDIT，DELETE, GET, LOGIN，LOGOUT]   [%X{loperateType}]</td></tr> <tr><td>请求的url</td> <td>Y</td> <td>[/dpp-user/v2/users/createOrUpdate]</td> <td>[%X{req.requestURI}]</td></tr> <tr><td>请求方法</td> <td>Y</td> <td>[POST]</td> <td>POST,DELETE、PUT   [%X{req.method}]</td></tr> <tr><td>请求参数</td> <td>Y</td> <td>[userid=1]</td> <td>获取路径上的参数   [%X{req.queryString}]</td></tr> <tr><td>请求体</td> <td>Y</td> <td>[{&quot;truename&quot;:&quot;xcvdfsf&quot;,&quot;employeeNum&quot;:&quot;sdfsdfsdf&quot;,&quot;phone&quot;:&quot;17625320526&quot;,&quot;email&quot;:&quot;1564931941@<a href="http://qq.com/" target="_blank" rel="noopener noreferrer">qq.com<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>&quot;,&quot;userName&quot;:&quot;xcsdfsdfsdf&quot;,&quot;id&quot;:14014,&quot;userSource&quot;:&quot;Fleet   frame&quot;,&quot;userlevelid&quot;:&quot;1&quot;,&quot;roleID&quot;:&quot;1260&quot;,&quot;groupIds&quot;:[],&quot;ispwd&quot;:false,&quot;username&quot;:&quot;xcsdfsdfsdf&quot;}]</td> <td>获取路径上的参数   [%X{requestBody}]</td></tr> <tr><td>格式化后的消息</td> <td>Y</td> <td>[module is not exist! Your module name is:   PERFORMANCE_MONITORING_AND_ANALYSIS]</td> <td>例子：LOG4j 指令[   %msg]   英文双引号, &quot;&quot;</td></tr> <tr><td>用户浏览器agent</td> <td>Y</td> <td>[userAgent-Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36   (KHTML, like Gecko) Chrome/75.0.3770.100 Safari/537.36]</td> <td>用户浏览器请求的Agent String</td></tr> <tr><td>具体业务描述</td> <td>N</td> <td>[create or update user]</td> <td>[%X{businessDescription}]</td></tr> <tr><td>异常</td> <td>N</td> <td>[null point exception]</td> <td>输出和日志事件关联的异常的堆栈信息[%ex]</td></tr> <tr><td>操作的Web页面</td> <td>N</td> <td>[KnowleageBase/index.jsp]</td> <td>自定义   [%X{webUrl}]</td></tr> <tr><td>操作Web页面的文字性描述</td> <td>N</td> <td>[知识库首页]</td> <td>自定义   [%X{webDescribe}]</td></tr></tbody></table> <h3 id="日志格式"><a href="#日志格式" class="header-anchor">#</a> 日志格式</h3> <div class="language- extra-class"><pre class="language-text"><code>[%d] [%-5level] [%thread] [%X{tracePreFix}%X{X-B3-TraceId:-}] [%logger{36}] [line-%line] [ofm][sso-server] [%X{req.remoteHost}] [%serverName] [%serverIp] [%X{userName}] [%X{operateType}] [%X{req.method}] [%X{req.requestURI}]  [%X{req.queryString}] [%X{requestBody}] [%msg] [%X{req.userAgent}] [%X{businessDescription}] [webUrl-%X{webUrl}] [webDescribe-%X{webDescribe}] [%ex] %n
</code></pre></div><h3 id="使用样例"><a href="#使用样例" class="header-anchor">#</a> 使用样例</h3> <p>一般情况下，日志打印的内容都是根据配置文件中配置的pattern格式指定好的。在我们调用<a href="http://logger.info" target="_blank" rel="noopener noreferrer">logger.info<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>(), logger.debug()等日志打印方法时，打印的内容格式与配置文件中的pattern格式一致。
例如，在logback.xml配置文件中指定了日志打印格式：
<code>%d{HH:mm:ss.SSS} %-5level [%thread][%logger{0}-%L] %msg%n&quot;</code>。</p> <p>这些格式的意义在官网的文档上都有说明。其中<code>%msg</code>就是我们调用日志打印方法时输入的内容。
<strong>当官方指定的这些格式不能满足我们的需求，或者是我们需要在打印日志的时候，需要加上一些比较有规律的内容，例如打印本机的hostname/ip<strong><strong>等logback</strong></strong>本身没有提供的格式的时候，我们就可以自定义日志输出的内容与格式。</strong></p> <h2 id="方法一"><a href="#方法一" class="header-anchor">#</a> 方法一</h2> <h3 id="实现自定义converter"><a href="#实现自定义converter" class="header-anchor">#</a> 实现自定义Converter</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token keyword">package</span> com<span class="token punctuation">.</span>siemens<span class="token punctuation">.</span>ofmcommon<span class="token punctuation">.</span>log<span class="token punctuation">;</span>

<span class="token keyword">import</span> ch<span class="token punctuation">.</span>qos<span class="token punctuation">.</span>logback<span class="token punctuation">.</span>classic<span class="token punctuation">.</span>pattern<span class="token punctuation">.</span>ClassicConverter<span class="token punctuation">;</span>
<span class="token keyword">import</span> ch<span class="token punctuation">.</span>qos<span class="token punctuation">.</span>logback<span class="token punctuation">.</span>classic<span class="token punctuation">.</span>spi<span class="token punctuation">.</span>ILoggingEvent<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>InetAddress<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>UnknownHostException<span class="token punctuation">;</span>

<span class="token comment">/**
 * 主机名称
 * @author lw
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerName</span> <span class="token keyword">extends</span> <span class="token class-name">ClassicConverter</span> <span class="token punctuation">{</span>
    @Override
    <span class="token keyword">public</span> String <span class="token function">convert</span><span class="token punctuation">(</span><span class="token parameter">ILoggingEvent iLoggingEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String hostName <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            hostName <span class="token operator">=</span> InetAddress<span class="token punctuation">.</span><span class="token function">getLocalHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHostName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>UnknownHostException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> hostName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="修改配置文件"><a href="#修改配置文件" class="header-anchor">#</a> 修改配置文件</h3> <p>完成了自定义的Converter之后，就是将这个Converter配置到配置文件中。在logback配置文件中的根节点<code>&lt;configuration&gt;</code>下增加节点<code>&lt;conversionRule&gt;</code>，例如：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>conversionRule</span> <span class="token attr-name">conversionWord</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>serverIp<span class="token punctuation">&quot;</span></span> <span class="token attr-name">converterClass</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>com.siemens.ofmcommon.log.ServerIp<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>在</strong><code>**&lt;conversionRule&gt;**</code><strong>节点中的</strong><code>**conversionWord=&quot;serverIp&quot;**</code><strong>属性，就是表示在pattern****中指定</strong><code>**%serverIp**</code><strong>时，调用的就是</strong><code>**converterClass**</code><strong>属性中指定的Converter</strong></p> <h2 id="方法二"><a href="#方法二" class="header-anchor">#</a> 方法二</h2> <h3 id="使用注解方式自定义注解"><a href="#使用注解方式自定义注解" class="header-anchor">#</a> 使用注解方式自定义注解</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * Controller层自定义日志事件
 * @author z00403vj
 *
 */</span>
<span class="token annotation punctuation">@Inherited</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>METHOD<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">LogEventName</span> <span class="token punctuation">{</span>
	
	<span class="token comment">/**
	 * @return 操作的Web页面
	 */</span>
	<span class="token class-name">String</span> <span class="token function">webUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
	<span class="token comment">/**
	 * @return 操作Web页面的文字性描述
	 */</span>
	<span class="token class-name">String</span> <span class="token function">webDescribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span>  <span class="token punctuation">;</span>
	 
	<span class="token comment">/**
	 * @return 业务系统名称（例如：根据用户id发送邮件）
	 */</span>
	<span class="token class-name">String</span> <span class="token function">businessDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
	<span class="token comment">/**
	 * @return  操作类型[ 例如SUBMIT，CLOSE, LOGIN，LOGOUT, SESSIONTIMEOUT]
	 */</span>
	<span class="token class-name">String</span> <span class="token function">operateType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
	
	<span class="token comment">/**
	 * 是否查看方法执行时间，和jvm参数
	 * @return
	 */</span>
	<span class="token keyword">boolean</span> <span class="token function">analysisSwitch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>


<span class="token punctuation">}</span>

</code></pre></div><h3 id="方法添加注解"><a href="#方法添加注解" class="header-anchor">#</a> 方法添加注解</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/dpp-user/v2/log&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogController</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Resource</span> 
	<span class="token keyword">private</span> <span class="token class-name">TestLogService</span>				testLogService<span class="token punctuation">;</span>
	
	<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/info&quot;</span><span class="token punctuation">)</span>
	<span class="token annotation punctuation">@LogEventName</span><span class="token punctuation">(</span>operateType<span class="token operator">=</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">,</span>businessDescription<span class="token operator">=</span><span class="token string">&quot;test log&quot;</span>  <span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ModelMap</span> <span class="token function">ping</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> ip<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
		
		log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;log user log&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">ModelMap</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModelMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> sso <span class="token operator">=</span> testLogService<span class="token punctuation">.</span><span class="token function">logService</span><span class="token punctuation">(</span> ip <span class="token punctuation">)</span><span class="token punctuation">;</span>
		result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;ip&quot;</span><span class="token punctuation">,</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
		result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;sso&quot;</span><span class="token punctuation">,</span>sso<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="注解值放置到日志容器mdc"><a href="#注解值放置到日志容器mdc" class="header-anchor">#</a> 注解值放置到日志容器MDC</h3> <p><strong>controller Aop</strong>
记录了详情浏览器相关参数</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
* 日志切面
* @author z00403vj
*
*/</span>
<span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogAop</span> <span class="token punctuation">{</span>
<span class="token comment">/**
* 用户ID
*/</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> USERNAME <span class="token operator">=</span> <span class="token string">&quot;userName&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> START_TTIME_THREAD_LOCAL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NamedThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;ThreadLocal StartTime&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> SWICH_THREAD_LOCAL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NamedThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;ThreadLocal switch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;@annotation(com.siemens.ofmcommon.log.anotation.LogEventName)&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cutService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">&quot;cutService()&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">recordSysLog</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> point<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token function">handle</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;日志记录出错!&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//执行业务</span>
<span class="token class-name">Object</span> result <span class="token operator">=</span> point<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 删除</span>
MDC<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>SWICH_THREAD_LOCAL<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 打印JVM信息。</span>
<span class="token comment">//1. 得到线程绑定的局部变量（开始时间）</span>
<span class="token keyword">long</span> beginTime <span class="token operator">=</span> START_TTIME_THREAD_LOCAL<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//2、结束时间</span>
<span class="token keyword">long</span> endTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;cost:{}ms \tmaxMemory:{}m\tAllocated memory:{}m\tRemaining space in allocated memory:{}m\tMaximum available memory:{}m&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span>endTime <span class="token operator">-</span> beginTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">maxMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">totalMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">freeMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">maxMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">totalMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">freeMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
SWICH_THREAD_LOCAL<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
START_TTIME_THREAD_LOCAL<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> point<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
<span class="token comment">//获取拦截的方法名</span>
<span class="token class-name">Signature</span> sig <span class="token operator">=</span> point<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">MethodSignature</span> msig <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>sig <span class="token keyword">instanceof</span> <span class="token class-name">MethodSignature</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;该注解只能用于方法&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
msig <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MethodSignature</span><span class="token punctuation">)</span> sig<span class="token punctuation">;</span>
<span class="token class-name">Object</span> target <span class="token operator">=</span> point<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Method</span> currentMethod <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span>msig<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msig<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RequestAttributes</span> ra <span class="token operator">=</span><span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ServletRequestAttributes</span> sra<span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span>ra<span class="token punctuation">;</span>
<span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> sra<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> prefix <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">CommonConstants</span><span class="token punctuation">.</span>TRACEPREFIX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Users</span> loginUser <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Users</span><span class="token punctuation">)</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">CommonConstants</span><span class="token punctuation">.</span>USER_SESSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>loginUser <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
MDC<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>USERNAME<span class="token punctuation">,</span> loginUser<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 获取方法上的日志注解</span>
<span class="token class-name">LogEventName</span> logEvent <span class="token operator">=</span> currentMethod<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">LogEventName</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 没有logEvent的注解就不判断</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>logEvent <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">boolean</span> analysisSwitch <span class="token operator">=</span> logEvent<span class="token punctuation">.</span><span class="token function">analysisSwitch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>analysisSwitch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//1、开始时间</span>
<span class="token keyword">long</span> beginTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//线程绑定变量（该数据只有当前请求的线程可见）</span>
START_TTIME_THREAD_LOCAL<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>beginTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
SWICH_THREAD_LOCAL<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">String</span> webUrl <span class="token operator">=</span> logEvent<span class="token punctuation">.</span><span class="token function">webUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> webDescribe <span class="token operator">=</span> logEvent<span class="token punctuation">.</span><span class="token function">webDescribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> businessDescription <span class="token operator">=</span> logEvent<span class="token punctuation">.</span><span class="token function">businessDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> operateType <span class="token operator">=</span> logEvent<span class="token punctuation">.</span><span class="token function">operateType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNoneBlank</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
MDC<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;tracePreFix&quot;</span><span class="token punctuation">,</span> prefix <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
MDC<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;webUrl&quot;</span><span class="token punctuation">,</span> webUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
MDC<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;webDescribe&quot;</span><span class="token punctuation">,</span> webDescribe<span class="token punctuation">)</span><span class="token punctuation">;</span>
MDC<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;businessDescription&quot;</span><span class="token punctuation">,</span> businessDescription<span class="token punctuation">)</span><span class="token punctuation">;</span>
MDC<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;operateType&quot;</span><span class="token punctuation">,</span> operateType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RequestWrapper</span> requestWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestWrapper</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> body <span class="token operator">=</span> requestWrapper<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNoneBlank</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
MDC<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;requestBody&quot;</span><span class="token punctuation">,</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>service aop</strong></p> <div class="language-java extra-class"><pre class="language-java"><code>
<span class="token comment">/**
 * service切面
 * @author z00403vj
 *
 */</span>
<span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceAop</span> <span class="token punctuation">{</span>

  
	
	<span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">&quot;within(@org.springframework.stereotype.Service *) || within(@org.springframework.stereotype.Component *) &quot;</span><span class="token punctuation">)</span>  
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">serviceAspect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
	  
	<span class="token comment">/**
	 * service层只传输traceId已经业务相关前缀利于elk搜索整个链路
	 * @param point
	 * @return
	 * @throws Throwable
	 */</span>
	<span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">&quot;serviceAspect()&quot;</span><span class="token punctuation">)</span>  
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">service</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> point<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span><span class="token punctuation">{</span>
		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> copyOfContextMap <span class="token operator">=</span> MDC<span class="token punctuation">.</span><span class="token function">getCopyOfContextMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		 
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>copyOfContextMap<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">String</span> put <span class="token operator">=</span>  copyOfContextMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;X-B3-TraceId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">String</span> tracePreFix <span class="token operator">=</span> MDC<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;tracePreFix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			MDC<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> newMap<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			newMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;X-B3-TraceId&quot;</span><span class="token punctuation">,</span>put<span class="token punctuation">)</span><span class="token punctuation">;</span>
			MDC<span class="token punctuation">.</span><span class="token function">setContextMap</span><span class="token punctuation">(</span>newMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
			MDC<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;tracePreFix&quot;</span><span class="token punctuation">,</span> tracePreFix <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	 <span class="token class-name">Object</span> proceed <span class="token operator">=</span> point<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> proceed<span class="token punctuation">;</span>  
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><h3 id="修改配置文件logback-xml"><a href="#修改配置文件logback-xml" class="header-anchor">#</a> 修改配置文件logback.xml</h3> <div class="language-json extra-class"><pre class="language-json"><code>&lt;property name=<span class="token string">&quot;PATTERN&quot;</span> value=&quot;<span class="token punctuation">[</span>%d<span class="token punctuation">]</span> <span class="token punctuation">[</span>%<span class="token number">-5</span>level<span class="token punctuation">]</span> <span class="token punctuation">[</span>%thread<span class="token punctuation">]</span>
<span class="token punctuation">[</span>%logger<span class="token punctuation">{</span><span class="token number">36</span><span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>line-%line<span class="token punctuation">]</span> <span class="token punctuation">[</span>ofm<span class="token punctuation">]</span><span class="token punctuation">[</span>sso-server<span class="token punctuation">]</span> <span class="token punctuation">[</span>%X<span class="token punctuation">{</span>req.remoteHost<span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>%serverName<span class="token punctuation">]</span>
<span class="token punctuation">[</span>%serverIp<span class="token punctuation">]</span> <span class="token punctuation">[</span>%X<span class="token punctuation">{</span>userName<span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>%X<span class="token punctuation">{</span>operateType<span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>%X<span class="token punctuation">{</span>req.method<span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>%X<span class="token punctuation">{</span>req.requestURI<span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>%X<span class="token punctuation">{</span>req.queryString<span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>%X<span class="token punctuation">{</span>requestBody<span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>%msg<span class="token punctuation">]</span>
<span class="token punctuation">[</span>%X<span class="token punctuation">{</span>req.userAgent<span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>%X<span class="token punctuation">{</span>businessDescription<span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>webUrl-%X<span class="token punctuation">{</span>webUrl<span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>webDescribe-%X<span class="token punctuation">{</span>webDescribe<span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>%ex<span class="token punctuation">]</span> %n &quot; /&gt;
</code></pre></div><p>修改pattern中的获取MDC容器注入的参数operateType和用户名称userName</p> <h3 id="输出样例"><a href="#输出样例" class="header-anchor">#</a> 输出样例</h3> <p>[2019-07-05 14:30:51,591] [ERROR] [http-nio-8091-exec-10]
[c.s.d.w.c.DppUsersController] [line-234] [ofm][user] [172.19.210.145]
[md1tz9pc] [10.0.75.1] [admin123456] [user] [POST]
[/dpp-user/v2/users/createOrUpdate] []
[{&quot;truename&quot;:&quot;xcvsdfsdf&quot;,&quot;employeeNum&quot;:&quot;sdfsd3e123&quot;,&quot;phone&quot;:&quot;17625320526&quot;,&quot;email&quot;:&quot;1564931sdf941
q.com&quot;,&quot;userName&quot;:&quot;zxp666&quot;,&quot;id&quot;:14084,&quot;userSource&quot;:&quot;Fleet
frame&quot;,&quot;userlevelid&quot;:&quot;1&quot;,&quot;roleID&quot;:&quot;1260###1252&quot;,&quot;groupIds&quot;:[96],&quot;ispwd&quot;:false,&quot;username&quot;:&quot;zxp666&quot;}]
[EMAIL_INVALIDATE] [PostmanRuntime/6.3.2] [create or update user] [webUrl-]
[webDescribe-] []</p> <h3 id="自定义规则"><a href="#自定义规则" class="header-anchor">#</a> 自定义规则</h3> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>添加自定义日志
方法一、
1、增加一条日志规则，在ofm-common  项目中logEvent注解类中添加一个字段。
2、在controller请求方法上添加logEvent注解，增加上面增加的字段
3、在SessionInterceptor拦截器中添加自定义规则至MDC日志容器中。
4、在logback.xml配置打印输出格式：  [新规则-%X{新规则}]</p></div> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>方法二、
1、新增类继承ClassicConverter类重写convert方法返回自定义属性
2、在logback.xml中导入规则
3、配置输出格式：  [新规则-%{新规则}]</p></div> <h3 id="系统已存在可使用规则"><a href="#系统已存在可使用规则" class="header-anchor">#</a> 系统已存在可使用规则</h3> <p><strong>规则</strong></p> <div class="language-java extra-class"><pre class="language-java"><code>   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> REQUEST_REMOTE_HOST_MDC_KEY <span class="token operator">=</span> <span class="token string">&quot;req.remoteHost&quot;</span><span class="token punctuation">;</span> 
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> REQUEST_USER_AGENT_MDC_KEY <span class="token operator">=</span> <span class="token string">&quot;req.userAgent&quot;</span><span class="token punctuation">;</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> REQUEST_REQUEST_URI <span class="token operator">=</span> <span class="token string">&quot;req.requestURI&quot;</span><span class="token punctuation">;</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> REQUEST_QUERY_STRING <span class="token operator">=</span> <span class="token string">&quot;req.queryString&quot;</span><span class="token punctuation">;</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> REQUEST_REQUEST_URL <span class="token operator">=</span> <span class="token string">&quot;req.requestURL&quot;</span><span class="token punctuation">;</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> REQUEST_METHOD <span class="token operator">=</span> <span class="token string">&quot;req.method&quot;</span><span class="token punctuation">;</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> REQUEST_X_FORWARDED_FOR <span class="token operator">=</span> <span class="token string">&quot;req.xForwardedFor&quot;</span><span class="token punctuation">;</span>
使用方法 <span class="token punctuation">[</span>requestMethod<span class="token operator">-</span><span class="token operator">%</span><span class="token class-name">X</span><span class="token punctuation">{</span>req<span class="token punctuation">.</span>method<span class="token punctuation">}</span>
</code></pre></div><h3 id="涉及的方法"><a href="#涉及的方法" class="header-anchor">#</a> 涉及的方法</h3> <p>1、删除系统中原来的类：loginInfo.java userAgent.java、requestIp.java、responseTime.java、operationType、Userldapid、logFormatUtill.等
2、ofm-common<strong><strong>新增logEvent</strong></strong>注解**OperationContent ServerIp ServerName
3、微服务使用注解需增加LogAop拦截方法、MyComponent使用系统提供的日志信息
RequestWrapper http请求包装请求requestBody
ChannelFilter过滤器避免因为包装http请求获取一次 后失效。
具体参考sso-server或者dpp-user
4、调用第三方的方法使用Resttemplete是新增RestTraceInterceptor拦截器。在header头中添加tracePreFIx传输到链路中。若使用fignClient调用则使用类似的添加拦截实现RequestInterceptor拦截器添加请求头header参数
restemplate</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RestTraceInterceptor</span>  <span class="token keyword">implements</span> <span class="token class-name">ClientHttpRequestInterceptor</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ClientHttpResponse</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">HttpRequest</span> request<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">,</span> <span class="token class-name">ClientHttpRequestExecution</span> execution<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">HttpHeaders</span> headers <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">CommonConstants</span><span class="token punctuation">.</span>TRACEPREFIX<span class="token punctuation">,</span> MDC<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;tracePreFix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClientHttpResponse</span> execute <span class="token operator">=</span> execution<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> execute<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="微服务日志跟踪"><a href="#微服务日志跟踪" class="header-anchor">#</a> <a href="http://www.baidu.com/link?url=nss9QCHDc_cGT3rK3Lf4iHs3tLNI6qygeN9FPMel7XRGWGtss6ISlPyER2pInHPG-VFteSaixPJhsrjgpZAJ4a" target="_blank" rel="noopener noreferrer">微服务日志跟踪 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></h3> <p>Spring Cloud Sleuth是一个在应用中实现日志跟踪的强有力的工具。使用Sleuth库可以应用于计划任务 、多线程服务或复杂的Web请求，尤其是在一个由多个服务组成的系统中。当我们在这些应用中来诊断问题时，即使有日志记录也很难判断出一个请求需要将哪些操作关联在一起。
如果想要诊断复杂操作，通常的解决方案是在请求中传递唯一的ID到每个方法来识别日志。而Sleuth可以与日志框架Logback、SLF4J轻松地集成，通过添加独特的标识符来使用日志跟踪和诊断问题。
Spring Cloud Sleuth在实现时依然使用了MDC容器存储
在Spring Boot Web应用中增加Sleuth非常简单，只需在pom.xml增加以下的依赖：</p> <h3 id="依赖"><a href="#依赖" class="header-anchor">#</a> <strong>依赖</strong></h3> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-sleuth<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><h3 id="一个简单的web应用链路"><a href="#一个简单的web应用链路" class="header-anchor">#</a> 一个简单的WEB应用链路</h3> <p>首先在user创建一个服务</p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/dpp-user/v2/log&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogController</span> <span class="token punctuation">{</span>
     
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">TestLogService</span>              testLogService<span class="token punctuation">;</span>
     
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/info&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@LogEventName</span><span class="token punctuation">(</span>operateType<span class="token operator">=</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">,</span>businessDescription<span class="token operator">=</span><span class="token string">&quot;test log&quot;</span><span class="token punctuation">,</span>traceIdPre<span class="token operator">=</span><span class="token string">&quot;testLog&quot;</span> <span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ModelMap</span> <span class="token function">ping</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> ip<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
         
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;log user log&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ModelMap</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModelMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> sso <span class="token operator">=</span> testLogService<span class="token punctuation">.</span><span class="token function">logService</span><span class="token punctuation">(</span> ip <span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;ip&quot;</span><span class="token punctuation">,</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;sso&quot;</span><span class="token punctuation">,</span>sso<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
 
<span class="token punctuation">}</span>
 
 
<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestLogService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;ribbonRestTemplate&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span>                ribbonRestTemplate<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">logService</span><span class="token punctuation">(</span><span class="token class-name">String</span> ip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;user servicd log start  ,ip{}&quot;</span><span class="token punctuation">,</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> sso <span class="token operator">=</span> ribbonRestTemplate<span class="token punctuation">.</span><span class="token function">postForObject</span><span class="token punctuation">(</span><span class="token string">&quot;http://sso-server/cas/log/info?ip=&quot;</span><span class="token operator">+</span>ip<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;user servicd log end  ,ip{}&quot;</span><span class="token punctuation">,</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sso<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
<span class="token punctuation">}</span>

</code></pre></div><p>然后在sso写一个controller去调用这个服务</p> <p><strong>service</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/cas/log&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">LogService</span> logService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/info&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@LogEventName</span><span class="token punctuation">(</span>operateType<span class="token operator">=</span><span class="token string">&quot;log&quot;</span><span class="token punctuation">,</span>businessDescription<span class="token operator">=</span><span class="token string">&quot;test ip &quot;</span><span class="token punctuation">,</span>traceIdPre<span class="token operator">=</span><span class="token string">&quot;testLog&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">ping</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> ip<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;start sso log&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logService<span class="token punctuation">.</span><span class="token function">logService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;success and param is&quot;</span><span class="token operator">+</span>ip <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
 
<span class="token punctuation">}</span>
 <span class="token operator">*</span> 日志service测试
 <span class="token operator">*</span> <span class="token annotation punctuation">@author</span> z00403vj
 <span class="token operator">*</span>
 <span class="token operator">*</span><span class="token operator">/</span>
<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogService</span> <span class="token punctuation">{</span>
     
     
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">logService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;service log&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         
        <span class="token keyword">return</span> <span class="token string">&quot;hai&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
<span class="token punctuation">}</span>

</code></pre></div><p>启动应用，访问<a href="http://10.192.30.167:8091/dpp-user/v2/log/info?ip=22.22" target="_blank" rel="noopener noreferrer">http://10.192.30.167:8091/dpp-user/v2/log/info?ip=22.22<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，添加请求头</p> <p>tracePreFix ：sdsdsfsdfsdfsdfsdfsdf</p> <h2 id="查看日志"><a href="#查看日志" class="header-anchor">#</a> 查看日志</h2> <h3 id="user模块"><a href="#user模块" class="header-anchor">#</a> user模块</h3> <div class="language-xml extra-class"><pre class="language-xml"><code>[2019-07-17 11:31:42,271] [INFO ] [http-nio-8091-exec-8] [sdsdsfsdfsdfsdfsdfsdf81468141aa9caa60]
[c.s.d.web.controller.LogController] [line-33] [ofm][user] [] [md1tz9pc]
[10.0.75.1] [admin123456] [open] [] [] [] [ ] [log user log] [] [test log] []
[] [] 

[2019-07-17 11:31:42,272] [INFO ] [http-nio-8091-exec-8] [sdsdsfsdfsdfsdfsdfsdf81468141aa9caa60]
[c.s.d.web.service.TestLogService] [line-16] [ofm][user] [] [md1tz9pc]
[10.0.75.1] [] [] [] [] [] [] [user servicd log start ,ipddd] [] [] [] [] [] 

[2019-07-17 11:31:42,410] [INFO ] [http-nio-8091-exec-8]
[sdsdsfsdfsdfsdfsdfsdf81468141aa9caa60] [c.s.d.web.service.TestLogService]
[line-18] [ofm][user] [] [md1tz9pc] [10.0.75.1] [] [] [] [] [] [] [user servicd
log end ,ipddd] [] [] [] [] []
</code></pre></div><h3 id="sso模块"><a href="#sso模块" class="header-anchor">#</a> sso模块</h3> <div class="language- extra-class"><pre class="language-text"><code>[2019-07-17 11:31:42,302] [INFO ] [http-nio-8008-exec-1]
[sdsdsfsdfsdfsdfsdfsdf81468141aa9caa60] [c.s.f.s.controller.LogController]
[line-30] [ofm][ofm-sso] [] [md1tz9pc] [10.0.75.1] [] [log] [] [] [] [] [start
sso log] [] [test ip ] [] [] [] 

[2019-07-17 11:31:42,304] [INFO ] [http-nio-8008-exec-1]
[sdsdsfsdfsdfsdfsdfsdf81468141aa9caa60] [c.s.f.server.service.LogService]
[line-19] [ofm][ofm-sso] [] [md1tz9pc] [10.0.75.1] [] [] [] [] [] [] [service
log] [] [] [] [] []
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>日志的格式可选为：[application name, traceId, spanId, export]
</code></pre></div><p><code>&quot;service&quot;: &quot;${springAppName:-}&quot;, &quot;trace&quot;: &quot;%X{X-B3-TraceId:-}&quot;, &quot;span&quot;: &quot;%X{X-B3-SpanId:-}&quot;, &quot;parent&quot;: &quot;%X{X-B3-ParentSpanId:-}&quot;, &quot;exportable&quot;: &quot;%X{X-Span-Export:-}&quot;</code></p> <p>名词解释：</p> <ul><li><p><strong>application name</strong> — 应用的名称，也就是application.properties中的<a href="http://spring.application.name" target="_blank" rel="noopener noreferrer">spring.application.name<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>参数配置的属性。</p></li> <li><p><strong>traceId</strong> — 为一个请求分配的ID号，用来标识一条请求链路。</p></li> <li><p><strong>spanId</strong> — 表示一个基本的工作单元，一个请求可以包含多个步骤，每个步骤都拥有自己的spanId。一个请求包含一个TraceId，多个SpanId</p></li> <li><p><strong>export</strong> — 布尔类型。表示是否要将该信息输出到类似Zipkin这样的聚合器进行收集和展示。</p></li></ul> <p>可以看到，TraceId和SpanId在两条日志中是相同的，即使消息来源于两个不同的类。这就可以在不同的日志通过寻找traceid来识别一个请求。</p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">9/12/2019, 4:48:48 PM</span></div></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.fbf1b08b.js" defer></script><script src="/assets/js/8.6b440de9.js" defer></script><script src="/assets/js/28.0251e2b8.js" defer></script>
  </body>
</html>
